<!-- this template will house a codemirror instance where a 
    function declaration or other significant code chunk will 
    be loaded -->


<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cards Editor</title>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel=stylesheet href="cm/docs.css">
  <link rel=stylesheet href="cm/codemirror.css">
  <link rel=stylesheet href="cm/merge.css">
  <link rel=stylesheet href="cm/icecoder.css">
  <style>
  </style>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!-- scripts -->
  <script src="cm/codemirror.js"></script>
  <script src="cm/css.js"></script>
  <!-- load local server version if cdn unavailable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <script>if (!window.jQuery) document.write('<script src="cm/diff_match_patch.js"><\/script>');</script>

  <script src="cm/htmlmixed.js"></script>
  <script src="cm/xml.js"></script>
  <script src="cm/merge.js"></script>
  <script src="cm/modes/javascript.js"></script>
  <script src="cm/modes/clike.js"></script>
  <script src="cm/modes/glsl.js"></script>
  
<!-- //   $( "#set div" ).draggable({ stack: "#set div" }); -->
  </script>
</head>
<body ondblclick="doubleClick(event);">


       
<button id="button" onclick="newCard()"></button>
<div class="deck">

</body>



<script>

// var elemDiv = document.createElement('div');
// document.body.appendChild(elemDiv);
// draggable.style.cssText = 'position:absolute;width:100%;height:100%;opacity:0.3;z-index:100;background:#000;';


// var myCodeMirror = CodeMirror({
//   value: "function myScript(){return 100;}\n",
//   mode:  "clike",
//   lineNumbers: 1
// });

// document.body.draggable.appendChild(myCodeMirror)

// document.getElementById("draggable").innerHTML = myCodeMirror;


// var myCodeMirror = CodeMirror.fromTextArea(view, {
//     value: "function myScript(){return 100;}\n",
//   mode:  "clike"

// });
var cardIdArray = []; //store the list of card ID names
var value = "leftCodeEditor content"
orig1 = "origRight editor content"

var count = 1;
var cardId = 1; //id for each new card div created

//double-click anywhere on html body to create new card
function doubleClick(e) {
                    // e.target -> element that was clicked
                //    console.log(e.target)
    var body = e.target
    if (body.nodeName == "BODY"){
        newCard(e.pageX, e.pageY);
        console.log(e.pageX, e.pageY)
    }
}


function newCard(x, y){
    cardId = ("card_" + (count ++));
    cardIdArray.push(cardId)
    value = ("leftCodeEditor content" + cardId)
    
    //var toAdd = $('input[name=annotateItem]').val();
    // $('.margin').append("<div class='note'>"+toAdd+"</div>");
            
    // create a 'card' div, place it at the mouse position
    var $item = $('<div class="card" id="' + cardId + '" style="position: absolute; left: ' + x + '; top: ' + y + '";/>')

    // (2) make it draggable and auto-reorder the cards based on last-clicked (stack)
    $item.draggable({ stack: cardId + " div" });    
    
    

    // (3) append it to the document
    $item.appendTo('.deck');

    initUI();   
    $( function() {
        $( cardId )
    });  
   
}
//make card Divs draggable
// $( function() {
//     $( cardIdArray ).draggable({ scroll: true });
//   } );







//get and set code in either of the MergeView editor panes
function initUI() {
   // isRightDirty = false;

    if (value == null) return;
    console.log('received div id ' + cardId)
    var target = document.getElementById(cardId);
    target.innerHTML = "";
    dv = CodeMirror(target, {
        value: value,
        // origLeft: panes == 3 ? orig1 : null,
        // origRight: orig1,
        lineNumbers: true,
        mode: "clike",
        //highlightDifferences: "highlight",
        
        //NOTE: viewportMargin, when set to 'infinity', allows for full text searching, BUT when set to a high number seems to have been the source of the sluggishness in the client app!! so now its only at 10. 
        viewportMargin: 10,
        revertButtons: true,
        allowEditingOriginals: true,
        // autoRefresh: true,
        // showDifferences: true,
        linewrapping: true,
        // connect: "connect",
        // theme: "icecode",
        // collapseIdentical: true,
        // collapse: collapse
        

        
        /* init: */
        //place cursor in left editor at client init
        autofocus: 1,

            //TODO: disable/enable editing in the codemirror instance. will use this once user worktrees are set up so that editing can only be enabled once a user worktree is chosen (or created). Once a worktree is chosen, change the readOnly value to false.
            //readOnly: "nocursor"
        //set tab index for editor
        //  tabindex: 2,
        

        //editing
        undoDepth: 200,


        //cursor settings:
        cursorBlinkRate: 300,
        cursorScrollMargin: 0
    });
/* this is if we want to check that the code has changed: 

    //when new code loaded into right pane, reset isRightDirty flag   
    isRightDirty = false;

    //when user changes something in origRight, always create a new branch from this point in the history (new branch starting from previously chosen commit)
    dv.editor().on("changes", function(dv, changeObj){
        // && currentBranch == "master"
        console.log("editedRightCode" + authorName.split(' ').join('_') + '_' + selectedCommit + "_" + new Date().getTime() + " " + selectedCommit)
        if (isRightDirty == false) {
             ws.send("editedRightCode" + authorName.split(' ').join('_') + '_' + selectedCommit + "_" + new Date().getTime() + " " + selectedCommit)
 */
        //    switch (currentBranch) {
        //         case "master":
        //         console.log("the current branch is MASTER")

        //         ws.send("newBranch" + thisHash);
        //         break;

        //         case (currentBranch !== "master"):
        //         console.log("The current branch is " + currentBranch)
        //         if (confirm("already on branch " + currentBranch + "This branch began from " + thisHash + "Create new?")) {
        //             // Save it!
        //         } 
        //         //alert("already on branch " + currentBranch + "\nstarted from " + thisHash + "create new?")
        //         break;


        }
   
        //  if (currentBranch == "master")
        //     {

        //         //TODO: then switch to new branch by sending this message to server + the currently selected commit hash

        //         // ws.send("newBranch" + thisHash);
        //     }
        // else {
        //             //TODO: alert user already on branch, ask if you want to switch to a new branch
        //     }
/*
        isRightDirty = true;

    });


}
*/
function mergeViewHeight(mergeView) {
    function editorHeight(editor) {
        if (!editor) return 0;
        return editor.getScrollInfo().height;
    }
    return Math.max(editorHeight(mergeView.leftOriginal()),
    editorHeight(mergeView.editor()),
    editorHeight(mergeView.rightOriginal()));
} 


</script>
</html>