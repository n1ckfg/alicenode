<!doctype html>
<html>
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
<title>Alicenode State Editor</title>

<head>
<!-- //TEMPORARY: just to aid in development workflow -->
<!-- <meta http-equiv="refresh" content="5; URL=http://localhost:8080"> -->
<!--        SOURCES         -->
<!-- Codemirror -->
    <!-- styles -->

    <link rel=stylesheet href="cm/docs.css">
    <link rel=stylesheet href="cm/codemirror.css">
    <link rel=stylesheet href="cm/addons/fullscreen/fullscreen.css">
    <link rel=stylesheet href="cm/one-dark.css">



    <!-- <link rel=stylesheet href="cm/merge.css">
    <link rel=stylesheet href="cm/icecoder.css"> -->

    <!-- scripts -->
    <script src="cm/codemirror.js"></script>
    <script src="cm/css.js"></script>
    <!-- load local server version if cdn unavailable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script><script>if (!window.jQuery) document.write('<script src="cm/diff_match_patch.js"><\/script>');</script>

    <!-- <script src="cm/htmlmixed.js"></script> -->
    <!-- <script src="cm/xml.js"></script> -->
    <!-- <script src="cm/merge.js"></script> -->
    <!-- <script src="cm/modes/javascript.js"></script> -->
    <script src="cm/modes/clike.js"></script>
    <script src="cm/modes/glsl.js"></script>
      <script src="cm/addons/buttons/buttons.js"></script>
  <script src="cm/addons/panel.js"></script>
  <script src="cm/addons/fullscreen/fullscreen.js"></script>
  <script src="cm/cm-resize.js"></script>


<!-- General Sources -->
    <!-- style -->
    <link rel=stylesheet href="css/jquery-ui.css">

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <link rel=stylesheet href="css/cards.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- resizeable columns -->
    <link rel=stylesheet href="css/colresizeable.css">

    <script src="js/colResizable-1.5.min.js"></script>

    <script src="js/jquery.mousewheel.js"></script>

    <!-- server address & open/close -->

</head>

<style>

    body {
    /* background-color: rgb(43, 40, 44); */
}

/* <!-- rgb(39, 174, 96)
rgb(142, 68, 173)
rgb(218, 247, 166)
rgb(255, 195, 0)
rgb(255, 87, 51)
rgb(199, 0, 57) --> */
/* .cm {
    width:200px;
   	margin:auto;
    font-size:14px;
    border:1px solid #000;
    border-collapse:collapse; }

.cm td {
    color:#000099;
    vertical-align:middle;
    text-align:left;
    border:1px solid #000;
    height: 100% } */

/* .stateParams {

} */
</style>

<!-- containing table -->
<table width="100%" height="100%">
    <tr  height="5%" >
        <th style="text-decoration: none">Alicenode State Editor</th>
        <th><input id="server" type="text" value="ws://localhost:8080" size="40">
            <button onclick="openSocket()">Open</button>
            <button onclick="closeSocket()">Close</button></th>
    </tr>
    <tr>
        <td valign="top" height="90%">     
            <!-- table for the state.h code editor -->
            <table name="cm" display="inline-block" id="state.h" width="100%" border="0" cellpadding="0" cellspacing="0" >
                    <tr >
                        <th >state.h</th>
                    </tr>
                    <tr>
                        <td > 
                            <div id="stateh_source"></div>
                        </td>
                    </tr>
                
            </table>
        </td>
        <td valign="top">
            <!-- table for the state.h parameters and values -->
            <table name="stateParams" overflow="scroll" id="stateValues" width="100%" border="0" cellpadding="0" cellspacing="0" display="inline-block";>
                <tbody>
                    <tr >
                        <th style="width: 60%;">Parameter</th>
                        <th style="width: 40%;">Value</th>          
                    </tr>
                </tbody>
            </table>
        </td>
    </tr>

</table>

<script>
    
var cardIdArray = []; //store the list of card ID names
var value = "//new card" //default contents of a new card. can be replaced by a code fragment from the server

var count = 1; //count the number of cards generated, start at 1
var cardId = 1; //id for each new card div created

var bodySize = [document.body.clientWidth, document.body.clientHeight]
var ws_url;
var worktreeList;
var history;
var ws;
var ws_url = "ws://" + window.location.host;
//the alicenode state:
var state;

function log(msg){
  console.log(msg)
}

function updateState(paramName, paramValue){
    state[paramName] = paramValue
    console.log(state)
}

// $('.param').click(function() {
//   console.log($(this).attr('value'));
// });
// <!-- 
// $(document).click(function(event) {
//     var text = $(event.target).text();
//     console.log(text)
// });

// $(document).click(function(event) {
//     console.log($(event.target).text());
// }); -->
document.getElementById('server').value = ws_url;

function openSocket() {
    log('opening');
    var url = document.getElementById('server').value;
    ws = new WebSocket(ws_url);
    ws.binaryType = 'arraybuffer';
    ws.onopen = function() {
        // log('open');  
        // ws.send("client_SVG?")

        // ws.send("getCurrentBranch")
        
        // //temporary: for now set user as Guest so I don't have to keep choosing user while developing. 
        // ws.send("selectUser?" + "Guest");
        
        sessionStorage.echoServer = url;
    };
    ws.onclose = function() {
        // log('close');
    };
    ws.onmessage = function(e) {
        /*if (e.data instanceof Blob) {
            var reader = new FileReader();
            reader.onload = function(e) {
                log('received blob: ' + encodeHexString(new Uint8Array(e.target.result)));
            };
            reader.readAsArrayBuffer(e.data);
        } else */
        if (e.data instanceof ArrayBuffer) {
            //log(encodeHexString(new Uint8Array(e.data)));
            //log("received arraybuffer size: " + e.data.byteLength + " bytes");
            
            let s = "";
            let fv = new Float32Array(e.data);
            for (var i = 0; i < fv.length; i+=3) {
                s += "<li>" + (i/3 + ": { " + fv[i] + ", " + fv[i+1] + ", " + fv[i+2] + " }</li>");
            }
            
            // document.getElementById('state').innerHTML = s;     
            
        } else {
            let message = e.data;
            let q = message.indexOf("?");
            if (q > 0) {
                let cmd = message.substring(0, q);
                let arg = message.substring(q+1);
                switch(cmd) {
                    
                    case "state.h":
                    

                    stateCode = JSON.parse(arg)
                    //note, we may not pass the state using state.h, but instead could just regen it from the ast received by the next case statement below, aka 'state'
                    console.log(stateCode)
                    sourceCard(stateCode)
                    //get and set code in the new card
                    function sourceCard(stateCode) {
                    // isRightDirty = false;
                        if (value == null) return;
                        var target = document.getElementById("stateh_source");

                        target.innerHTML = "";
                        dv = CodeMirror(target, {
                            //position: "relative",
                            value: stateCode,
                            // origLeft: panes == 3 ? orig1 : null,
                            // origRight: orig1,
                            lineNumbers: true,
                            mode: "clike",
                            //highlightDifferences: "highlight",
                            theme: 'one-dark',
                            //NOTE: viewportMargin, when set to 'infinity', allows for full text searching, BUT when set to a high number seems to have been the source of the sluggishness in the client app!! so now its only at 10. 
                            viewportMargin: 10,
                            revertButtons: true,
                            allowEditingOriginals: true,
                            // autoRefresh: true,
                            // showDifferences: true,
                            linewrapping: true,
                            //editing
                            undoDepth: 200,
                            //cursor settings:
                            cursorBlinkRate: 300,
                            cursorScrollMargin: 0,
                            
                        });
                        dv.setSize("100%", 750);

                    }


                    break;
                    
                    case "state":
                    state = (JSON.parse(arg))
                    //var newCard = [];

                    //console.log(state)
                    //note: we'll use a visitor function like the one below, but its not for the purpose of building a tree; rather we just need the parameter name and its value. we'll then pass it to this function below:
                    let paramName;
                    let paramValue;
                    Object.keys(state).forEach(function(key, value) {
                        console.log(key, state[key])
                        paramName = key;
                        paramValue = state[key];
                        $('#stateValues tr:last').after('<tr><td>' + paramName + '</td><td>' + '<input id=\"' + paramName + '\" class="param" onchange="updateState(this)" value=\"' + paramValue + '\"></input>' + '</td></tr>');
                        //turn the input element into a jquery spinner
                        $("#" + paramName).spinner();
                        //have the spinner report its value whenever it gets changed by mouse or keyboard events.
                        $( "#" + paramName ).spinner({spin: function( event, ui, id ) {
                            updateState(this.id, ui.value);
                            }
                        });
                        // $("#" + paramName).on("change paste keyup", function() {
                        //     console.log($("#" + paramName).val()); 
                        // });


                    })
                    // function addParameter(){
                    //     $('#stateValues tr:last').after('<tr><td>' + paramName + '</td><td>' + '<input id=\"' + paramName + '\" value=\"' + paramValue + '\"></input>' + '</td></tr>');



                    // }

                    
                    /*
                    //send astJSON to function that will regen the ast into full file (for loading into the Head node of the graph)
                    

                    
                    
                    let name;
                    newDeckArray = []

                    visit(arg)

                    function visit(node, parentnode, ctx) {
                        //console.log("enter", node.ast, "of", parentnode ? parentnode.ast : node.filename);
                        
                        if (node.ast == "TranslationUnit"){
                            ctx.name = node.filename;

                            //put this ast's filename into the filename column of the IDE table
                            $('#deckOneName').text(node.filename)

                        
                            //ctx.children.push(node.ast);

                            let ctx1 = {
                                name: name,
                                children: [],
                            }  


                                    // add more props depending on the node type

                            //first check if a node has children, if not, ignore. 
                            if (node.nodes){
                                
                                // do this for structs, tranlation units, 
                                // but not for functions
                                for (c of node.nodes) {
                                    visit(c, node, ctx1);
                                }
                            // console.log("exit", node.ast);

                                ctx.children.push(ctx1);

                                //ctx.children.push("</div>")
                            }
                        } else if (node.name) {

                        ctx.children.push(node.name);
                        ctx.name = node.name;

                        let ctx1 = {
                            name: name,
                            children: [],
                        }
                        
                            // add more props depending on the node type

                        //first check if a node has children, if not, ignore. 
                        if (node.nodes){
                            
                            // do this for structs, tranlation units, 
                            // but not for functions
                            for (c of node.nodes) {
                                visit(c, node, ctx1);
                            }

                            ctx.children.push(ctx1);

                        }

                    }

                    else if (node.mangled_name){

                        ctx.children.push(node.name);
                        ctx.name = node.name;

                        let ctx1 = {
                            name: name,
                            children: [],
                        }
                        
                            // add more props depending on the node type

                        //first check if a node has children, if not, ignore. 
                        if (node.nodes){
                            
                            // do this for structs, tranlation units, 
                            // but not for functions
                            for (c of node.nodes) {
                                visit(c, node, ctx1);
                            }
                        // console.log("exit", node.ast);

                            ctx.children.push(ctx1);

                        }

                    }

                    }

                    let ctx = {
                        name: name,

                        children: [],
                    }
                    //recurse through the rest of the JSON
                    visit(deck, null, ctx);
                    //build the new tree
                    //newDeck = JSON.stringify(ctx, null, 3);
                    //the tree builder expects an array but the visitor function outputs an object, so:
                    //create a new array...
                    newTree = new Array();
                    //...and then add ctx to the array as its only object

                    */

                    break;
                    default:
                        log("cmd: " + cmd + ", " + arg);
                    }
        
                } else {
            
                log('received: ' + e.data);
                }
            }
        };
    ws.onerror = function() {
        log('error');
    };
}

function closeSocket() {
    log('closing');
    ws.close();
}

// keep checking socket status, re-open if closed:
setInterval(function(){
        if (!ws || ws.readyState === WebSocket.CLOSED) openSocket();
}, 2000);


</script>


</body>
</html>