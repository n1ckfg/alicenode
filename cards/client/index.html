<!doctype html>

<title>Alicenode Editor</title>
<meta charset="utf-8"/>

<!-- //TEMPORARY: just to aid in development workflow -->
<!-- <meta http-equiv="refresh" content="5; URL=http://192.168.137.1:8080"> -->
<!--        SOURCES         -->
<!-- Codemirror -->
    <!-- styles -->
    <link rel=stylesheet href="cm/docs.css">
    <link rel=stylesheet href="cm/codemirror.css">
    <link rel=stylesheet href="cm/merge.css">
    <link rel=stylesheet href="cm/icecoder.css">

    <!-- scripts -->
    <script src="cm/codemirror.js"></script>
    <script src="cm/css.js"></script>
    <!-- load local server version if cdn unavailable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script><script>if (!window.jQuery) document.write('<script src="cm/diff_match_patch.js"><\/script>');</script>

    <script src="cm/htmlmixed.js"></script>
    <script src="cm/xml.js"></script>
    <script src="cm/merge.js"></script>
    <script src="cm/modes/javascript.js"></script>
    <script src="cm/modes/clike.js"></script>
    <script src="cm/modes/glsl.js"></script>

<!-- General Sources -->
    <!-- style -->
    <link rel=stylesheet href="css/jquery-ui.css">
    <link rel=stylesheet href="css/alicenode.css">

    <script src="js/jquery-3.3.1.js" type="javascript"></script>
    <script src="js/jquery.js" type="javascript"></script>



    <!-- server address & open/close -->
<input id="server" type="text" value="ws://localhost:8080" size="40">
<button onclick="openSocket()">Open</button>
<button onclick="closeSocket()">Close</button>

<body>

  <template id="mytemplate">
    <img src="" alt="great image">
    <div class="comment"></div>
  </template>
  
</body>

    <script>
    
    
    var ws_url;
var worktreeList;
var history;
var ws;
var ws_url = "ws://" + window.location.host;

function log(msg){
  console.log(msg)
}

//codemirror instance
var myCodeMirror = CodeMirror(document.body, {
  value: "function myScript(){return 100;}\n",
  mode:  "clike"
});

////codemirror card template

function supportsTemplate() {
  return 'content' in document.createElement('template');
}

if (supportsTemplate()) {
  // Good to go!
  console.log("browser supports templates")
} else {
  // Use old templating techniques or libraries.
  console.log("browser doesn't support templates")

}

var t = document.querySelector('#mytemplate');
// Populate the src at runtime.
t.content.querySelector('html').src = 'card.html';

var clone = document.importNode(t.content, true);
document.body.appendChild(clone);




document.getElementById('server').value = ws_url;

function openSocket() {
    log('opening');
    var url = document.getElementById('server').value;
    ws = new WebSocket(ws_url);
    ws.binaryType = 'arraybuffer';
    ws.onopen = function() {
        // log('open');  
        ws.send("client_SVG?")

        ws.send("getCurrentBranch")
        
        //temporary: for now set user as Guest so I don't have to keep choosing user while developing. 
        ws.send("selectUser?" + "Guest");

        sessionStorage.echoServer = url;
    };
    ws.onclose = function() {
        // log('close');
    };
    ws.onmessage = function(e) {
        /*if (e.data instanceof Blob) {
            var reader = new FileReader();
            reader.onload = function(e) {
                log('received blob: ' + encodeHexString(new Uint8Array(e.target.result)));
            };
            reader.readAsArrayBuffer(e.data);
        } else */
        if (e.data instanceof ArrayBuffer) {
            //log(encodeHexString(new Uint8Array(e.data)));
            //log("received arraybuffer size: " + e.data.byteLength + " bytes");
            
            let s = "";
            let fv = new Float32Array(e.data);
            for (var i = 0; i < fv.length; i+=3) {
                s += "<li>" + (i/3 + ": { " + fv[i] + ", " + fv[i+1] + ", " + fv[i+2] + " }</li>");
            }
            
            // document.getElementById('state').innerHTML = s;     
            
        } else {
            let message = e.data;
            let q = message.indexOf("?");
            if (q > 0) {
                let cmd = message.substring(0, q);
                let arg = message.substring(q+1);
                switch(cmd) {
                    
                    case "branchCommits":
                    var branchesList = arg.split("\n")
                    break;
                    default:
                        log("cmd: " + cmd + ", " + arg);
                    }
        
                } else {
            
                log('received: ' + e.data);
                }
            }
        };
    ws.onerror = function() {
        log('error');
    };
}

function closeSocket() {
    log('closing');
    ws.close();
}

// keep checking socket status, re-open if closed:
setInterval(function(){
        if (!ws || ws.readyState === WebSocket.CLOSED) openSocket();
}, 2000);


</script>


