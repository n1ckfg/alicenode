<!doctype html>

<title>CodeMirror: merge view demo</title>
<meta charset="utf-8"/>

<!-- Codemirror -->
<link rel=stylesheet href="cm/docs.css">
<link rel=stylesheet href="cm/codemirror.css">
<link rel=stylesheet href="cm/merge.css">
<script src="cm/codemirror.js"></script>
<!-- <script src="/cm/xml.js"></script> -->
<script src="cm/css.js"></script>
<script src="js/diff_match_patch.js"></script>
<script src="cm/merge.js"></script>
<script src="cm/modes/javascript.js"></script>
<script src="cm/modes/clike.js"></script>
<script src="cm/modes/glsl.js"></script>
<script type="text/javascript" src="js/diff_match_patch.js"></script>

<!--script sources for the repo_graph & jquery -->
<script type="text/javascript" src="js/jquery.2.1.3.min.js"></script>
<script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="js/jquery.color.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.graphviz.svg.js"></script>


<style>
    .CodeMirror { line-height: 1.2; }
    @media screen and (min-width: 1300px) {
      article { max-width: 100%; }
      #nav { border-right: 499px solid transparent; }
    }
    span.clicky {
      cursor: pointer;
      background: #d70;
      color: white;
      padding: 0 3px;
      border-radius: 3px;
    }
  </style>
<!-- <div id=nav>
   <a href="http://codemirror.net"><h1>CodeMirror</h1><img id=logo src="../doc/logo.png"></a> 

   <ul>
    <li><a href="../index.html">Home</a>
    <li><a href="../doc/manual.html">Manual</a>
    <li><a href="https://github.com/codemirror/codemirror">Code</a>
  </ul> 
   <ul>
    <li><a class=active href="#">merge view</a>
  </ul> 
</div> -->


<p>
    <input id="server" type="text" value="ws://localhost:8080" size="40">
    <button onclick="openSocket()">Open</button>
    <button onclick="closeSocket()">Close</button>
</p>

<div id=view></div>


<p>The merge addon provides an interface for displaying and merging diffs,
either <span class=clicky onclick="panes = 2; initUI()">two-way</span>
or <span class=clicky onclick="panes = 3; initUI()">three-way</span>.
The left (or center) pane is editable, and the differences with the
other pane(s) are <span class=clicky
onclick="toggleDifferences()">optionally</span> shown live as you edit
it. In the two-way configuration, there are also options to pad changed
sections to <span class=clicky onclick="connect = connect ? null :
'align'; initUI()">align</span> them, and to <span class=clicky
onclick="collapse = !collapse; initUI()">collapse</span> unchanged
stretches of text.</p>


<!-- mouseover stuff -->

<h3 id="commit_detail"></h3>

<!-- server messages -->
<ul id="messages"></ul>

<!--code for the repository graph -->

<div id="graph" style="width: 100%; height: 20%; overflow: scroll; position: fixed; bottom: 0;"></div>


<script>
//ws

        var ws_url = "ws://" + window.location.host;
        
        console.log(ws_url);
        
		document.getElementById('server').value = ws_url;

        var ws;
        function openSocket() {
            log('opening');
            var url = document.getElementById('server').value;
            ws = new WebSocket(ws_url);
            ws.binaryType = 'arraybuffer';
            ws.onopen = function() {
                loadSVG();
               // log('open');
                sessionStorage.echoServer = url;
            };
            ws.onclose = function() {
               // log('close');
            };
            ws.onmessage = function(e) {
                /*if (e.data instanceof Blob) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        log('received blob: ' + encodeHexString(new Uint8Array(e.target.result)));
                    };
                    reader.readAsArrayBuffer(e.data);
                } else */
                if (e.data instanceof ArrayBuffer) {
                    //log(encodeHexString(new Uint8Array(e.data)));
                    //log("received arraybuffer size: " + e.data.byteLength + " bytes");
                    
                    let s = "";
                    let fv = new Float32Array(e.data);
                    for (var i = 0; i < fv.length; i+=3) {
  						s += "<li>" + (i/3 + ": { " + fv[i] + ", " + fv[i+1] + ", " + fv[i+2] + " }</li>");
					}
					
                   // document.getElementById('state').innerHTML = s;
                    
                    
                } else {
                	let message = e.data;
                	let q = message.indexOf("?");
					if (q > 0) {
						let cmd = message.substring(0, q);
						let arg = message.substring(q+1);
                		switch(cmd) {
                		case "fps":
                		//	document.getElementById('fps').innerHTML = arg;
                			break;
                		case "edit":
                          //  editorCM.setValue(arg);
                         //fillEditor("a" + arg);
                        // console.log(arg)

                              // orig1 = arg + value.replace(/\.\.\//g, "codemirror/").replace("yellow", "orange");
                              value = arg

                              initUI();                          
                            break;
                        //
                        case "show":
                           // fillEditor("b" + arg);


                              // orig1 = arg + value.replace(/\.\.\//g, "codemirror/").replace("yellow", "orange");
                              orig1 = arg;

                              initUI();
                           // console.log(arg)
                            break;    
                		case "state":
                			//document.getElementById('state').innerHTML = arg;
                			break;
                        case "updateRepo":
                            loadSVG();
                            log('Update Repo Graph')
                            break;
                		default:
                			log("cmd: " + cmd + ", " + arg);
                		}
                
					} else {
					
						log('received: ' + e.data);
					}
                }
            };
            ws.onerror = function() {
                log('error');
            };
        }
        function closeSocket() {
            log('closing');
            ws.close();
        }
		
		// keep checking socket status, re-open if closed:
		setInterval(function(){
			 if (!ws || ws.readyState === WebSocket.CLOSED) openSocket();
		}, 2000);
		
		function sendCode() {
         //   var message = "edit?" + editorCM.getValue();   
         var message = "edit?" + mergeEditor.getValue(); //HOW DO WE GET THE CURRENT STATE OF THE CODEMIRROR IN MERGEVIEW??
            console.log(mergeEditor);
            //log('sending: ' + message);
            ws.send(message);
        }
	
        function sendText() {
            var message = document.getElementById('message').value;
            log('sending: ' + message);
            ws.send(message);
        }
        function sendBinary() {
            var message = decodeHexString(document.getElementById('message').value);
            log('sending binary: ' + encodeHexString(message));
            ws.send(new Uint8Array(message).buffer);
        }
        function decodeHexString(text) {
            if (text.search(/[^0-9a-f\s]/i) !== -1) {
                alert('Can\'t decode "' + text + '" as hexadecimal...');
            } else {
                text = text.replace(/\s/g, '');
                if (text.length % 2 === 1) {
                    text = '0' + text;
                }
                var data = [];
                for (var i = 0, len = text.length; i < len; i += 2) {
                    data.push(parseInt(text.substr(i, 2), 16));
                }
              //  return data;
            }
        }
        function encodeHexString(data) {
            var bytes = [];
            for (var i = 0, len = data.length; i < len; i++) {
                var value = data[i];
                bytes[i] = value.toString(16);
                if (value < 16) {
                    bytes[i] = '0' + bytes[i];
                }
            }
            return bytes.join(' ');
        }
        function log(message) {
        	var li = document.createElement('li');
			li.innerHTML = message;
			document.getElementById('messages').appendChild(li);
        }
        if (sessionStorage.echoServer) {
            document.getElementById('server').value = sessionStorage.echoServer;
        }
		
		openSocket();



//tell git to revert to master commit HEAD
//function revertMaster() {
   // ws.send("git return to master");
   // }

//load the repo graph svg
function loadSVG(){


  //  console.log(ws_url);
            $(document).ready(function(){
                $("#graph").graphviz({
                    url: "repo_graph.svg",
                    shrink: "0", 
                  // tooltips: "init, update, show",
                   //highlight: "selected",
                    ready: function() {
                        var gv = this
                        //console.log(gv.nodesByName());

                        //gv.tooltip($elements, show);
                        //console.log(gv.highlight());

                        gv.nodes().click(function () {
                            var $set = $()
                            $set.push(this)
                            $set = $set.add(gv.linkedFrom(this, true))
                            $set = $set.add(gv.linkedTo(this, true))
                            gv.highlight($set, true)

                         ws.send("git show " + $(this).attr("data-name"));

                        })


                        
                      //  gv.nodes().mouseenter(function () {
                        //    var $set = $()
                          //  $set.push(this)
                   //         $set = $set.add(gv.linkedFrom(this, true))
                     //       $set = $set.add(gv.linkedTo(this, true))
                       //     gv.highlight(selected, true)
                         //   console.log($(this).attr("data-name"));


                        //})


                        //mouseover a digraph node: reveal its commit hash
                        gv.nodes().mouseenter(function(){
                            
                         //   gv.highlight(selected, true)
                            var hash = ($(this).attr("data-name"));
                            //var hashData = ($.getJSON('log.json', function(data) {
                             //   var details = ($(data).attr(this));

                             //var details = data[hash];
                            commit_detail.innerText = hash;
                               ws.send("hash" + hash);
                              // console.log(details);

                           // }))
                               //console.log($(this).attr("data-name"));
                             //  commit_detail.innerText = hash;
                              // ws.send("hash" + hash);
                             //  console.log(this)
                                })
                    }
                });
            });

  }      

                  //      gv.nodes().mouseenter(function(){
                               

                    //           commit_detail.innerText = hash;
                      //         ws.send("hashDetail + " hash);
                        //        })






var value, orig1, dv, panes = 2, highlight = true, connect = "align", collapse = true;
function initUI() {
  if (value == null) return;
  var target = document.getElementById("view");
  target.innerHTML = "";
  dv = CodeMirror.MergeView(target, {
    value: value,
    // origLeft: panes == 3 ? orig1 : null,
    origRight: orig1,
    lineNumbers: true,
    mode: "clike",
    highlightDifferences: highlight,
    connect: connect,
    collapseIdentical: collapse
  });
 // console.log(origRight)
}

function toggleDifferences() {
  dv.setShowDifferences(highlight = !highlight);
}

//window.onload = function() {

var requested;
var current;
window.onload = function() {

//val = "athis is the current code"
  
//   let text = mergeEditor.getValue();
   //log(text)

  //  var route = val.charAt(0);
  //             switch(route) {
  //                  case "a":
  //                  var current = val.replace("a", "");
  //                  //console.log("current\n\n\n\n" + current)
  //                  break;

  //                  case "b":
  //                  var requested = val.replace("b", "");
  //                  console.log("earlier version\n\n\n\n\n" + requested)
  //                  break;

  //             }
// if (requested == null || undefined){
//   requested == 
// }
//current = "this is the current version of the code"
//requested = "this is an older version of the codddddddde"

  // value = document.documentElement.innerHTML;
  //value = "Edit here";
  orig1 = "expecting version "
  // orig1 = "expecting versions" + value.replace(/\.\.\//g, "codemirror/").replace("yellow", "orange");
  //this one below is cool. you can change just parts of the editor contents
  // orig2 = value.replace(/\u003cscript/g, "\u003cscript type=text/javascript ")
  //   .replace("white", "purple;\n      font: comic sans;\n      text-decoration: underline;\n      height: 15em");
  initUI();
  let d = document.createElement("div"); d.style.cssText = "width: 50px; margin: 7px; height: 14px"; dv.editor().addLineWidget(57, d)
};

function mergeViewHeight(mergeView) {
  function editorHeight(editor) {
    if (!editor) return 0;
    return editor.getScrollInfo().height;
  }
  return Math.max(editorHeight(mergeView.leftOriginal()),
                  editorHeight(mergeView.editor()),
                  editorHeight(mergeView.rightOriginal()));
}

function resize(mergeView) {
  var height = mergeViewHeight(mergeView);
  for(;;) {
    if (mergeView.leftOriginal())
      mergeView.leftOriginal().setSize(null, height);
    mergeView.editor().setSize(null, height);
    if (mergeView.rightOriginal())
      mergeView.rightOriginal().setSize(null, height);

    var newHeight = mergeViewHeight(mergeView);
    if (newHeight >= height) break;
    else height = newHeight;
  }
  mergeView.wrap.style.height = height + "px";
}
</script>
</article>
