<!doctype html>

<title>Alicenode Editor Client</title>
<meta charset="utf-8"/>

<!-- //TEMPORARY: just to aid in development workflow -->
<!-- <meta http-equiv="refresh" content="5; URL=http://192.168.1.48:8080/index_v2.html"> -->
<!--        SOURCES         -->
<!-- Codemirror -->
    <!-- styles -->
    <link rel=stylesheet href="cm/docs.css">

<link rel=stylesheet href="cm/codemirror.css">
<link rel=stylesheet href="cm/merge.css">
<link rel=stylesheet href="css/alicenode.css">
<script src="cm/codemirror.js"></script>
<script src="cm/xml.js"></script>
<script src="cm/css.js"></script>
<script src="cm/modes/javascript.js"></script>
<!-- <script src="cm/htmlmixed.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script> -->
<script src="cm/diff_match_patch.js"></script>
<script src="cm/merge.js"></script>


<!-- scripts -->
<script type="text/javascript" src="js/pako.js"></script>
<!-- <script type="text/javascript" src="js/pako_inflate.js"></script> -->
<!-- <script type="text/javascript" src="js/pako_deflate.js"></script> -->
<script src="js/jquery-3.3.1.js"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/jquery.mousewheel.min.js"></script>
<script src="js/jquery.color.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.graphviz.svg.js"></script>

<!-- temp fix for the 'cannot find 'favicon.ico' error -->
<link rel="shortcut icon">


<style>
    .CodeMirror { line-height: 1.2; }
    @media screen and (min-width: 1300px) {
      article { max-width: 1000px; }
      #nav { border-right: 499px solid transparent; }
    }
    span.clicky {
      cursor: pointer;
      background: #d70;
      color: white;
      padding: 0 3px;
      border-radius: 3px;
    }
  </style>
<body>

     <!-- Client 'logs in' to server using the full name and email associated with their github account -->
<table style="width: 100%; float: left; background-color: rgba(19, 119, 32, 0.74)"> 
        <tr style="float: left">
            <th style="text-decoration: none">
                <form name="usernames">
                        <select id="chooseUser" onchange="userSelect();">
                                <option selected disabled>Please Select User</option> 
                                <option value="Add User...">Add User...</option>
                                <option value="Guest">Guest</option>
                    
                        </select> Current User
                            <!-- emailmichaelpalumbo@gmail.com -->
                    </form>
            </th>
    
    
            <th>
                <button onclick="window.open('http://192.168.137.1:8080')" id="myButton">New Editor</button>
            </th>
    
            <th>
                    <button onclick="clientNewBranch()" id="newBranch">New Branch</button>
    
            </th>
        
        </tr>
    
    
    
        <!-- Customize the Codemirror Instance -->
    
        <tr style="float: right">
            
                <th>
                        <p><b>Editor Settings: </b></p> 
                    </th>
            
                    <th>
                        <div class="onoffswitch">
                            <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="toggleLiveDiffing" onclick="toggleDifferences()" checked>
                            <label class="onoffswitch-label" for="toggleLiveDiffing"></label>
                        </div>Diffing
                    </th>
            
                    <th>
                        <div class="onoffswitch">
                            <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="toggleCollapse" onclick="collapse = !collapse; initUI()">
                            <label class="onoffswitch-label" for="toggleCollapse"></label>
                        </div>Collapse Changes
                    </th>
            
                    <th>
                        <div class="onoffswitch">
                            <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="toggleAlign" onclick="connect = connect ? null : 'align'; initUI()">
                            <label class="onoffswitch-label" for="toggleAlign"></label>
                        </div>Align Changes
            
                    </th>
        </tr>
    
    </table>


    <table style="background-color: blue" width=100%>  
        <tr>
            <th style="background-color:rgb(255, 150, 243); font-size: 14px; text-decoration: none; text-align: center;"><b>Branches</b></th>
            <th style="background-color:rgb(255, 150, 243); font-size: 14px; text-decoration: none; text-align: center;"><b>Files within Selected Branch</b></th>
            <th style="background-color:rgb(255, 150, 243); font-size: 14px; text-decoration: none; text-align: center;"><p id="fileInCommit"><p>
                
            </th>
    
        </tr>
        <tr> 
            <td style="width:33%; height:100%">
                <div id="Branch">
                    <select style="width:100%; height:100%" name="branches" size="5" id="chooseBranch" onchange="chooseBranch();"> 
                    </select> 
                </div>
                
            </td>
            <td style="width:33%; height:100%; text-align:center;">
    
                    <select size="5" style="width:100%; overflow: scroll;" id="openFileName" onchange="chooseFileName();">
                            <option selected disabled>Please Select File</option> 
                            <option value="New File...">New File...</option>
                            
                
                    </select> 
    
    
                </td>
    
            <td style="width:33%; height:100%; text-align:center;">
                <!-- <div id="CommitList"> -->
                    <select style="width:100%; height:100%" name="Commitslist" size="5" id="selectCommit" onchange="chooseCommit();"> 
                    </select> 
                <!-- </div>        -->
            </td>
    <!-- view files affected by selected commit. choose one to load into Codemirror -->
            <!-- <td style="width:33%; height:100%;  text-align:center;">
    
            </td> -->
        </tr>
    </table>

<div id="container">
    <div id="view"></div>
    
    <div id="gitgraph" style="text-align: left; padding-left: 10px"></div>
</div>
<table width="80%">
        <tr>
            <th style="text-align:left">
                    <button onclick="sendLeftCode()">Send Left Code</button>


            </th>
            <th>
                    <button onclick="sendCodeRelay()">Send Right Code</button>



            </th>
        </tr>
</table>

<!-- Chat and System Logs -->
<!-- <table width="100%" height="30%" style="background-color: rgb(225, 225, 225)">
        <tr height="20%">
            <th>Chat and System Messages</th>
            <th>Integrated Terminal (Your Machine)</th>
    
        </tr>
    
        <tr height="100%">
            <td  style="text-align:center; width:50%; height:300px;" >
                <ul id="chat_messages"></ul> 
                
            </td>
            <td style="text-align:center; width:50%; height:300px;">
                    <div id="terminal"></div>
            </td>
        </tr>
        <tr style="background-color: rgb(0, 0, 0)">           
            <td> 
                <form id="chat_form" overflow="scroll" onSubmit="return false;">
                    <input id="m" autocomplete="on" overflow="scroll" />
                    <button id="chatSendMsg" type="button" name="">Send</button>
                </form>  
            </td>
            </tr>
    </table> -->
    <div class="chatFooter">
         <div id="chatHeader">Chat and System Messages
             <div id="chat_messages">
            </div>
            <form id="chat_form" onSubmit="return false;">
                    <input id="m" autocomplete="on"/>
                    <button id="chatSendMsg" type="button" name="">Send</button>
                </form>  
        </div> 
        <div id="chatHeader" style="float: right;">Integrated Terminal
            <div id="terminal">
                jhbhjghujhyu
            </div>
            <li id="state"></li>
        </div>
    </div>

<!-- <p>The <a href="../doc/manual.html#addon_merge"><code>merge</code></a>
addon provides an interface for displaying and merging diffs,
either <span class=clicky onclick="panes = 2; initUI()">two-way</span>
or <span class=clicky onclick="panes = 3; initUI()">three-way</span>.
The left (or center) pane is editable, and the differences with the
other pane(s) are <span class=clicky
onclick="toggleDifferences()">optionally</span> shown live as you edit
it. In the two-way configuration, there are also options to pad changed
sections to <span class=clicky onclick="connect = connect ? null :
'align'; initUI()">align</span> them, and to <span class=clicky
onclick="collapse = !collapse; initUI()">collapse</span> unchanged
stretches of text.</p> -->

<!-- Manually Start and Stop Client -->
<input id="server" type="text" value="ws://localhost:8080" size="40">
<!-- <button onclick="openSocket()">Open</button>
<button onclick="closeSocket()">Close</button> -->

<script>

//Global Variables
var ws_url;
var ws;
//var ws_url = "ws://" + window.location.host + "mergeTestCode.html";
var ws_url = "ws://localhost:8080";
console.log(ws_url);

var test="test";
for(var i=0;i<100;i++){
    log(test);
}


var value, orig1, orig2, dv, panes = 2, highlight = true, connect = "align", collapse = false;
function initUI() {
  if (value == null) return;
  var target = document.getElementById("view");
  target.innerHTML = "";
  dv = CodeMirror.MergeView(target, {
    value: value,
    origLeft: panes == 3 ? orig1 : null,
    orig: orig2,
    lineNumbers: true,
    viewportMargin: 10,

    mode: "text/html",
    highlightDifferences: highlight,
    allowEditingOriginals: true,
    //connect: connect,
    collapseIdentical: collapse
  });
}

function toggleDifferences() {
  dv.setShowDifferences(highlight = !highlight);
}
value = "script";
window.onload = function() {
  orig1 = value;
  orig2 = value;
  initUI();
  let d = document.createElement("div"); d.style.cssText = "width: 50px; margin: 7px; height: 14px"; dv.editor().addLineWidget(57, d)
};

function mergeViewHeight(mergeView) {
  function editorHeight(editor) {
    if (!editor) return 0;
    return editor.getScrollInfo().height;
  }
  return Math.max(editorHeight(mergeView.leftOriginal()),
                  editorHeight(mergeView.editor()),
                  editorHeight(mergeView.rightOriginal()));
}

function resize(mergeView) {
  var height = mergeViewHeight(mergeView);
  for(;;) {
    if (mergeView.leftOriginal())
      mergeView.leftOriginal().setSize(null, height);
    mergeView.editor().setSize(null, height);
    if (mergeView.rightOriginal())
      mergeView.rightOriginal().setSize(null, height);

    var newHeight = mergeViewHeight(mergeView);
    if (newHeight >= height) break;
    else height = newHeight;
  }
  mergeView.wrap.style.height = height + "px";
}


//file selection
function chooseFileName(){
    var e = document.getElementById("openFileName");
    var selection = e.options[e.selectedIndex].value

    //clear the commits list in the select element each time a file is opened
    function removeOptions(selectbox){
        var i;
        for(i = selectCommit.options.length - 1 ; i>= 0 ; i--)
        {
            selectCommit.remove(i)
        }
    }
    removeOptions(document.getElementById("selectCommit"))
    fileInCommit.innerHTML = (selection + " found in following commits")


        if (selection == "New File..."){
            alert("Client not set up to create new file yet, work-in-progress")
        } else {
            ws.send("fileRequest" + selection)
            //change page title to filename!
            document.title = selection;

        }
    }



/**
 * Web Socket Client
 **/

document.getElementById('server').value = ws_url;

function openSocket() {
    log('opening');
    var url = document.getElementById('server').value;
    ws = new WebSocket(ws_url);
    ws.binaryType = 'arraybuffer';
    ws.onopen = function() {
        // log('open');  
        // ws.send("client_SVG?")

        // ws.send("getCurrentBranch")
        
        //temporary: for now set user as Guest so I don't have to keep choosing user while developing. 
        // ws.send("selectUser?" + "Guest");

        sessionStorage.echoServer = url;
    };
    ws.onclose = function() {
        // log('close');
    };

    ws.onmessage = function(e) {
        if (e.data instanceof ArrayBuffer) {
            
            let s = "";
            let fv = new Float32Array(e.data);
            for (var i = 0; i < fv.length; i+=3) {
                s += "<li>" + (i/3 + ": { " + fv[i] + ", " + fv[i+1] + ", " + fv[i+2] + " }</li>");
            }
        } else {
            let message = e.data;
            let q = message.indexOf("?");
            if (q > 0) {
                let cmd = message.substring(0, q);
                let arg = message.substring(q+1);
                switch(cmd) {



                    //set available users list
                    case "setUserList":
                    
                    userlist = JSON.parse(arg);
                    var sel = document.getElementById('chooseUser');
                    //var length = select;
                        
                    // for (i = 3; i < sel.length; i++) {
                    //     sel.options[i] = null;
                    //     }
                    Object.keys(userlist).forEach(function (key) {
                        var opt = document.createElement('option');
                        opt.appendChild( document.createTextNode(key) );
                        opt.value = key;
                        sel.appendChild(opt);
                    })
                    sel.selectedIndex = 2; 

                    break;

                    //////List all Branches, Files, Commits:
                    
                    //Branches List
                    case "setBranchList":
                    //  console.log(arg)
                    // <form name="branches"> 
                    //  <select id="chooseBranch" onchange="chooseBranch();"> 


                        var branchesList = arg.split("\n")
                        
                        // usebranchList = JSON.parse(arg);
                        var sel = document.getElementById('chooseBranch');
                        //var length = select;
                            
                        // for (i = 3; i < sel.length; i++) {
                        //     sel.options[i] = null;
                        //     }
                        Object.values(branchesList).forEach(function (value, key) {
                            var opt = document.createElement('option');
                            opt.appendChild( document.createTextNode(value) );
                            opt.value = value;
                            sel.appendChild(opt);
                            //find out the current branch, and highlight it in the select.
                            if (value.includes("*")) {
                                sel.selectedIndex = key
                            }
                        })
                        //sel.selectedIndex = 0;

                    break;
                    //Files List
                    case "setFileList":
                    
                    fileList = JSON.parse(arg);
                        var sel = document.getElementById('openFileName');
                        //var length = select;
                            
                        // for (i = 3; i < sel.length; i++) {
                        //     sel.options[i] = null;
                        //     }
                        Object.values(fileList).forEach(function (key, value) {
                            var opt = document.createElement('option');
                            opt.appendChild( document.createTextNode(key) );
                            opt.value = key;
                            sel.appendChild(opt);
                        })
//                        sel.selectedIndex = 2; 

                    break;


                    case "branchCommits":
                    var branchesList = arg.split("\n")
                        

                    // name="CommitList" size="5" id="ChooseCommit

                    // usebranchList = JSON.parse(arg);
                    var sel = document.getElementById('selectCommit');
                    //var length = select;
                        
                    // for (i = 3; i < sel.length; i++) {
                    //     sel.options[i] = null;
                    //     }
                    Object.values(branchesList).forEach(function (value, key) {
                        var opt = document.createElement('option');
                        opt.appendChild( document.createTextNode(value) );
                        opt.value = value;
                        sel.appendChild(opt);
                        //find out the current branch, and highlight it in the select.

                            //default set right editor at most-recent commit
                            sel.selectedIndex = 0;
                        
                        })

                        break;
                    default:
                   // log("cmd: " + cmd + ", " + arg);
                }
    
            } else if (message.includes("chatMsg")){

            } else {
            log('received: ' + e.data);
            }
        }
    };
        ws.onerror = function() {
        log('error');
    };
}

function closeSocket() {
    log('closing');
    ws.close();
}

// keep checking socket status, re-open if closed:
setInterval(function(){
        if (!ws || ws.readyState === WebSocket.CLOSED) openSocket();
}, 2000);


//Client log
function log(message) {
    var li = document.createElement('li');
    li.innerHTML = ("system: " + message);
     var list = document.getElementById('chat_messages');
     list.appendChild(li);
}

if (sessionStorage.echoServer) {
    document.getElementById('server').value = sessionStorage.echoServer;
}
</script>

</body>
